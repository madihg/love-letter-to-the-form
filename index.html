<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Love Letter to the Form — an interactive web poem by Halim Madi">
  <title>Love Letter to the Form</title>
  <style>
    /* === RESET + BASE === */
    *, *::before, *::after { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    @media (prefers-reduced-motion: reduce) {
      html { scroll-behavior: auto; }
    }

    body {
      font-family: 'Times New Roman', Times, serif;
      margin: 0;
      padding: 1.5rem;
      padding-bottom: 50vh;
      background-color: #fff;
      color: #000;
      line-height: 1.6;
      font-size: 1.125rem;
      transition: background-color 0.8s ease, color 0.8s ease;
      overflow-x: hidden;
    }
    body.inverted {
      background-color: #000;
      color: #fff;
    }
    @media (prefers-reduced-motion: reduce) {
      body { transition: none; }
    }

    /* === LAYOUT === */
    main {
      max-width: 640px;
      margin: 0 auto;
    }
    section {
      padding: 2rem 0;
      position: relative;
      min-height: 40vh;
    }
    section[hidden] { display: none; }

    .sr-only {
      position: absolute; width: 1px; height: 1px;
      padding: 0; margin: -1px; overflow: hidden;
      clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }

    /* === TYPOGRAPHY === */
    .line {
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.4s ease, transform 0.4s ease;
      margin: 0.5rem 0;
    }
    .line.visible {
      opacity: 1;
      transform: translateY(0);
    }
    @media (prefers-reduced-motion: reduce) {
      .line { transform: none; transition: none; }
      .line.visible { opacity: 1; }
    }

    /* === ARROW BUTTON === */
    .advance-arrow {
      display: block;
      margin: 2rem auto;
      padding: 0.75rem 1.5rem;
      font-family: 'Courier New', Courier, monospace;
      font-size: 1.25rem;
      background: none;
      border: 1px solid currentColor;
      cursor: pointer;
      color: inherit;
      transition: background-color 0.2s ease;
      letter-spacing: 0.1em;
    }
    .advance-arrow:hover {
      background: #f3f3f3;
    }
    .advance-arrow:focus-visible {
      outline: 2px solid currentColor;
      outline-offset: 2px;
    }
    body.inverted .advance-arrow:hover {
      background: #333;
    }
    .advance-arrow[hidden] { display: none; }

    /* === PART 1: LENS === */
    .p1-opening {
      position: relative;
      padding: 1rem 0;
    }
    .red-streak {
      position: absolute;
      width: 80%;
      height: 3px;
      background: #c0392b;
      top: 50%;
      left: 10%;
      z-index: -1;
      transition: background-color 0.8s ease;
    }
    body.inverted .red-streak {
      background: #fff;
    }
    @media (prefers-reduced-motion: reduce) {
      .red-streak { transition: none; }
    }

    .lens-area {
      position: relative;
      margin: 2rem 0;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .lens-text {
      font-size: 1.125rem;
      text-align: center;
      z-index: 1;
      transition: opacity 0.3s ease;
    }
    .lens-circle {
      position: absolute;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      border: 3px solid currentColor;
      background: transparent;
      pointer-events: none;
      box-shadow: inset 0 0 0 2px currentColor,
                  inset 0 0 0 5px transparent,
                  inset 0 0 0 6px currentColor;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .lens-circle.visible {
      opacity: 1;
    }
    .lens-btn {
      display: inline-block;
      margin: 1rem auto;
      padding: 0.5rem 1rem;
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.9rem;
      background: none;
      border: 1px solid currentColor;
      cursor: pointer;
      color: inherit;
    }
    .lens-btn:hover { background: #f3f3f3; }
    body.inverted .lens-btn:hover { background: #333; }

    .p1-figure {
      margin: 1.5rem 0;
    }

    /* === PART 2: SLOT MACHINE === */
    .slot-machine {
      display: flex;
      gap: 0.4ch;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      padding: 2rem 0;
      flex-wrap: wrap;
    }
    .reel {
      height: 1.8em;
      overflow: hidden;
      position: relative;
      transition: width 0.4s ease, opacity 0.4s ease;
    }
    .reel.empty {
      width: 0 !important;
      opacity: 0;
      margin: 0;
      padding: 0;
    }
    .reel-strip {
      display: flex;
      flex-direction: column;
      transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .reel-word {
      height: 1.8em;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    @keyframes reel-spin {
      0% { transform: translateY(0); }
      30% { transform: translateY(-1.8em); }
      60% { transform: translateY(0.5em); }
      100% { transform: translateY(var(--target)); }
    }
    .reel-strip.spinning {
      animation: reel-spin 0.6s cubic-bezier(0.35, 0, 0.25, 1) forwards;
    }
    @media (prefers-reduced-motion: reduce) {
      .reel-strip.spinning { animation: none; }
      .reel { transition: none; }
    }

    /* Wall */
    .wall-container {
      margin: 2rem 0;
    }
    .wall-phrase {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid currentColor;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .wall-phrase.visible {
      opacity: 1;
      transform: translateY(0);
    }
    @media (prefers-reduced-motion: reduce) {
      .wall-phrase { transform: none; transition: none; }
    }

    /* Drag rectangles */
    .drag-stack {
      position: relative;
      height: 200px;
      margin: 2rem 0;
    }
    .drag-rect {
      position: absolute;
      padding: 0.75rem 1.25rem;
      border: 1px solid currentColor;
      background: inherit;
      cursor: grab;
      user-select: none;
      touch-action: none;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      white-space: nowrap;
      transition: opacity 0.4s ease;
    }
    .drag-rect.dragging { cursor: grabbing; z-index: 10; }
    .drag-rect.dismissed { opacity: 0.15; pointer-events: none; }

    /* Curl text */
    .curl-container {
      margin: 2rem 0;
      font-style: italic;
      cursor: default;
      min-height: 2em;
    }
    .curl-char {
      display: inline-block;
      transition: transform 0.15s ease-out;
    }

    /* === PART 3: CAMERA + EYES === */
    .camera-container {
      width: min(320px, 80vw);
      aspect-ratio: 4/3;
      margin: 1.5rem auto;
      border: 1px solid currentColor;
      overflow: hidden;
      position: relative;
    }
    .camera-container video { display: none; }
    .camera-container canvas {
      width: 100%; height: 100%;
      image-rendering: pixelated;
    }

    .shy-line { margin: 1rem 0; }
    .shy-word {
      display: inline-block;
      transition: font-weight 0.2s, font-size 0.4s cubic-bezier(0.17,0.67,0.2,1.2);
    }
    @keyframes shy-jump {
      0%   { transform: translateY(0); }
      30%  { transform: translateY(-30px); }
      50%  { transform: translateY(-30px); }
      100% { transform: translateY(0); }
    }
    .shy-word.bold { font-weight: bold; }
    .shy-word.jump { animation: shy-jump 0.5s ease-in-out; }
    .shy-word.grow { font-size: 4rem; }
    @media (prefers-reduced-motion: reduce) {
      .shy-word { transition: none; }
      .shy-word.jump { animation: none; }
    }

    .eyes-container {
      display: flex;
      justify-content: center;
      gap: 3rem;
      padding: 2rem 0;
    }
    .eye {
      width: 80px; height: 80px;
      border-radius: 50%;
      border: 2px solid currentColor;
      position: relative;
      overflow: hidden;
      background: #fff;
    }
    body.inverted .eye { background: #fff; }
    .iris {
      width: 30px; height: 30px;
      border-radius: 50%;
      background: #666;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      transition: transform 0.1s ease-out;
    }
    .pupil {
      width: 14px; height: 14px;
      border-radius: 50%;
      background: #000;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      transition: transform 0.1s ease-out;
    }

    /* === PART 4: DRAG TRANSFORM + FLOAT === */
    .drag-transform {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 2rem 0;
      min-height: 80px;
      flex-wrap: wrap;
    }
    .source-words, .target-words {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5ch;
      flex: 1;
    }
    .drag-word {
      cursor: grab;
      touch-action: none;
      user-select: none;
      padding: 0.25rem;
      transition: opacity 0.4s ease;
    }
    .drag-word.dragging { cursor: grabbing; }
    .drag-word.crossed { opacity: 0.15; pointer-events: none; }
    .oblique-line {
      width: 2px;
      height: 80px;
      background: currentColor;
      transform: rotate(15deg);
      flex-shrink: 0;
    }
    .target-word {
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .target-word.revealed { opacity: 1; }

    .float-container {
      margin: 2rem 0;
      min-height: 100px;
      position: relative;
      overflow: hidden;
    }
    .float-word {
      display: inline-block;
      position: relative;
      margin: 0 0.3em;
    }

    /* === PART 5: HTML ELEMENT POETRY === */
    .p5-line {
      margin: 1.5rem 0;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .p5-line.visible { opacity: 1; }
    @media (prefers-reduced-motion: reduce) {
      .p5-line { transition: none; }
    }

    .p5-btn {
      font-family: 'Courier New', Courier, monospace;
      padding: 0.5rem 1.5rem;
      border: 1px solid #999;
      background: none;
      color: #999;
      cursor: not-allowed;
      font-size: 1rem;
      transition: border-color 0.15s, color 0.15s;
    }
    .p5-btn.flash {
      border-color: currentColor;
      color: inherit;
      cursor: pointer;
    }

    .p5-checkbox-label {
      cursor: pointer;
      font-style: italic;
      border-bottom: 1px dotted #999;
      padding-bottom: 2px;
    }
    .p5-hidden-check { position: absolute; opacity: 0; width: 0; height: 0; }

    .p5-select {
      font-family: 'Courier New', Courier, monospace;
      font-size: 1rem;
      padding: 0.25rem 0.5rem;
      border: 1px solid currentColor;
      background: none;
      color: inherit;
      cursor: pointer;
      -webkit-appearance: auto;
    }

    .p5-glitch {
      font-family: 'Courier New', Courier, monospace;
      font-size: 1.75rem;
      cursor: pointer;
      letter-spacing: 0.05em;
      padding: 0.5rem 0;
      display: inline-block;
      min-width: 200px;
    }

    .p5-details {
      border: 1px solid #ccc;
      padding: 0.5rem 1rem;
    }
    .p5-details summary {
      cursor: pointer;
      font-family: 'Courier New', Courier, monospace;
      color: #999;
      font-size: 0.85rem;
      list-style: none;
    }
    .p5-details summary::-webkit-details-marker { display: none; }
    .p5-details p {
      color: #666;
      margin: 0.5rem 0 0;
    }

    .p5-range {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 2px;
      background: #ccc;
      outline: none;
      margin: 1rem 0 0.5rem;
    }
    .p5-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px; height: 14px;
      background: #000;
      border-radius: 50%;
      cursor: pointer;
    }
    .p5-range::-moz-range-thumb {
      width: 14px; height: 14px;
      background: #000;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }
    .p5-range-label {
      transition: letter-spacing 0.1s ease;
    }

    .p5-textarea {
      font-family: 'Times New Roman', Times, serif;
      font-size: 1rem;
      width: 100%;
      min-height: 80px;
      border: 1px solid currentColor;
      padding: 0.75rem;
      background: none;
      color: inherit;
      resize: none;
      line-height: 1.6;
    }
    .p5-mirror {
      font-family: 'Times New Roman', Times, serif;
      color: #bbb;
      font-size: 1rem;
      line-height: 1.6;
      margin-top: 0.25rem;
      transform: scaleY(-1);
      opacity: 0.4;
      pointer-events: none;
      max-height: 60px;
      overflow: hidden;
    }

    /* === FOOTNOTES === */
    .footnote-anchor { position: relative; }
    .footnote-marker {
      cursor: pointer;
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.75rem;
      vertical-align: super;
      margin-left: 2px;
      color: #999;
    }
    .footnote-marker:hover { color: inherit; }
    .footnote-box {
      position: absolute;
      background: #fff;
      color: #000;
      border: 1px solid #000;
      padding: 1rem;
      max-width: min(400px, 80vw);
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.8rem;
      line-height: 1.5;
      z-index: 100;
      left: 0;
      top: 100%;
      margin-top: 0.5rem;
    }
    .footnote-box[hidden] { display: none; }

    /* === 3D WING === */
    .wing-stage {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      cursor: pointer;
    }
    .wing-label {
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.75rem;
      color: #ccc;
      letter-spacing: 0.3em;
      margin-bottom: 2rem;
    }
    .wing-perspective {
      perspective: 1200px;
      width: 400px;
      height: 300px;
      position: relative;
    }
    .wing-body {
      position: absolute;
      left: 50%;
      top: 60%;
      transform-style: preserve-3d;
      transform: rotateY(-15deg) rotateX(5deg);
      transition: transform 0.3s ease;
    }
    .feather {
      position: absolute;
      transform-origin: 0% 50%;
      background: #000;
      border-radius: 0 1px 1px 0;
    }
    body.inverted .feather { background: #fff; }
    .feather-text {
      position: absolute;
      top: -1.2em;
      left: 20%;
      font-family: 'Times New Roman', Times, serif;
      font-size: 0.55rem;
      color: #999;
      white-space: nowrap;
      pointer-events: none;
    }
    @keyframes flap {
      0%   { transform: rotateY(-15deg) rotateX(5deg); }
      15%  { transform: rotateY(-15deg) rotateX(-35deg); }
      35%  { transform: rotateY(-15deg) rotateX(15deg); }
      55%  { transform: rotateY(-15deg) rotateX(-20deg); }
      75%  { transform: rotateY(-15deg) rotateX(8deg); }
      100% { transform: rotateY(-15deg) rotateX(5deg); }
    }
    @keyframes feather-flex {
      0%   { transform: rotateZ(var(--angle)) rotateY(var(--y-tilt)); }
      15%  { transform: rotateZ(calc(var(--angle) - 5deg)) rotateY(calc(var(--y-tilt) + 10deg)); }
      35%  { transform: rotateZ(calc(var(--angle) + 3deg)) rotateY(calc(var(--y-tilt) - 5deg)); }
      55%  { transform: rotateZ(calc(var(--angle) - 2deg)) rotateY(calc(var(--y-tilt) + 5deg)); }
      100% { transform: rotateZ(var(--angle)) rotateY(var(--y-tilt)); }
    }
    .wing-body.flapping {
      animation: flap 2.8s cubic-bezier(0.25, 0, 0.35, 1) forwards;
    }
    .wing-body.flapping .feather {
      animation: feather-flex 2.8s cubic-bezier(0.25, 0, 0.35, 1) forwards;
      animation-delay: var(--delay, 0s);
    }
    .wing-hint {
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.7rem;
      color: #ccc;
      margin-top: 2rem;
      opacity: 0;
      transition: opacity 1s ease 1s;
    }
    .wing-hint.visible { opacity: 1; }
    @media (prefers-reduced-motion: reduce) {
      .wing-body.flapping {
        animation: none;
        transform: rotateY(-15deg) rotateX(-10deg);
        transition: transform 0.8s ease;
      }
      .wing-body.flapping .feather { animation: none; }
    }

    /* === MOBILE === */
    @media (max-width: 600px) {
      body { padding: 1rem; font-size: 1rem; }
      section { padding: 1.5rem 0; }
      .slot-machine { font-size: 1.25rem; }
      .eyes-container { gap: 2rem; }
      .eye { width: 60px; height: 60px; }
      .iris { width: 22px; height: 22px; }
      .pupil { width: 10px; height: 10px; }
      .drag-transform { flex-direction: column; align-items: stretch; }
      .oblique-line {
        width: 80px; height: 2px;
        transform: rotate(0deg);
        margin: 0.5rem auto;
      }
      .wing-perspective {
        width: 280px;
        height: 220px;
        transform: scale(0.75);
      }
      .footnote-box {
        position: fixed;
        bottom: 0; left: 0; right: 0;
        top: auto;
        max-width: 100%;
        margin: 0;
        border-left: none;
        border-right: none;
        border-bottom: none;
      }
    }
    @media (max-width: 380px) {
      .wing-perspective { transform: scale(0.6); }
      .slot-machine { font-size: 1.1rem; }
    }
  </style>
</head>

<body>
<main id="poem">
  <h1 class="sr-only">Love Letter to the Form</h1>

  <!-- ========== PART 1 ========== -->
  <section id="part-1" data-part="1" aria-label="Part 1: Autobiography of Red">
    <div class="p1-opening">
      <p class="line" data-step="0">In "Autobiography of Red", the camera acts as Geryon's emotional regulator.</p>
      <div class="red-streak" id="red-streak"></div>
    </div>

    <div class="lens-area">
      <div class="lens-circle" id="lens-circle" aria-hidden="true"></div>
      <span class="lens-text" id="lens-text">The lens is a locked bedroom door.</span>
    </div>
    <div style="text-align:center">
      <button class="lens-btn" id="lens-btn" data-interactive hidden>the lens</button>
    </div>

    <div class="p1-figure">
      <p class="line" id="p1-figure-line" data-step="figure">the figure from the ground.</p>
    </div>

    <span class="footnote-anchor" id="fn-anchor-1">
      <sup class="footnote-marker" role="button" tabindex="0" aria-expanded="false" data-footnote="1" hidden>*</sup>
    </span>
    <div class="footnote-box" id="footnote-1" hidden>
      Each border has a flavor, a taste. The aesthetics of semantics and the poetics of interface somatics are two boldly-flavored summer ice cream scoops. Pistachio and Melon. Chocolate and balsamic strawberry. That's a thing.
    </div>
  </section>

  <button class="advance-arrow" data-advances-to="2" aria-label="Continue to next section" hidden>&#8594;</button>

  <!-- ========== PART 2 ========== -->
  <section id="part-2" data-part="2" aria-label="Part 2: Slot Machine" hidden>
    <div class="slot-machine" id="slot-machine" data-interactive>
      <div class="reel" data-reel="0"><div class="reel-strip"><span class="reel-word">I</span></div></div>
      <div class="reel" data-reel="1"><div class="reel-strip"><span class="reel-word">am</span></div></div>
      <div class="reel" data-reel="2"><div class="reel-strip"><span class="reel-word">not</span></div></div>
      <div class="reel" data-reel="3"><div class="reel-strip"><span class="reel-word">trying</span></div></div>
      <div class="reel" data-reel="4"><div class="reel-strip"><span class="reel-word">to</span></div></div>
      <div class="reel" data-reel="5"><div class="reel-strip"><span class="reel-word">hide</span></div></div>
    </div>

    <div class="wall-container" id="wall-container" hidden>
      <div class="wall-phrase" data-wall="0">I am peeling parts</div>
      <div class="wall-phrase" data-wall="1">if you were to see me</div>
      <div class="wall-phrase" data-wall="2">really see me</div>
      <div class="wall-phrase" data-wall="3">we would both blush</div>
      <div class="wall-phrase" data-wall="4">and so I build borders</div>
    </div>

    <div class="drag-stack" id="drag-stack" data-interactive hidden>
      <div class="drag-rect" data-drag="0" style="z-index:7">the interface</div>
      <div class="drag-rect" data-drag="1" style="z-index:6">a drag</div>
      <div class="drag-rect" data-drag="2" style="z-index:5">sequin bodysuit</div>
      <div class="drag-rect" data-drag="3" style="z-index:4">drag</div>
      <div class="drag-rect" data-drag="4" style="z-index:3">of course both</div>
      <div class="drag-rect" data-drag="5" style="z-index:2">gesture and</div>
      <div class="drag-rect" data-drag="6" style="z-index:1">posture</div>
    </div>

    <div class="curl-container" id="curl-container" hidden>
      it's hard to write a straight text anymore
    </div>

    <span class="footnote-anchor" id="fn-anchor-2">
      <sup class="footnote-marker" role="button" tabindex="0" aria-expanded="false" data-footnote="2" hidden>*</sup>
    </span>
    <div class="footnote-box" id="footnote-2" hidden>
      As I write this, I realize I am dodging the heaviness of language by conjuring interface. "It's interactive", "code is part and parcel of this poem" &hellip; Interface is a way to buffer emotional risk. Lower the psychological stakes of the poet. And my costuming of poetry becomes both preening and pruning. Again, drag.
    </div>
  </section>

  <button class="advance-arrow" data-advances-to="3" aria-label="Continue to next section" hidden>&#8594;</button>

  <!-- ========== PART 3 ========== -->
  <section id="part-3" data-part="3" aria-label="Part 3: Camera and Eyes" hidden>
    <p class="line" data-step="camera">Take my face for instance.</p>

    <div class="camera-container" id="camera-container" data-interactive hidden>
      <video id="camera-video" autoplay playsinline muted></video>
      <canvas id="camera-canvas" width="320" height="240"></canvas>
    </div>

    <p class="line shy-line" data-step="shy">We would never lock eyes. I am not <span class="shy-word" id="shy-word">shy</span>.</p>

    <p class="line" data-step="maiko">Take the maiko's eyes. She runs her irises with an iron fist, logs her stares. To look you in the eyes would be as flagrant as bombing the ribs of a mountain.</p>

    <div class="eyes-container" id="eyes-container" data-interactive hidden>
      <div class="eye" aria-hidden="true">
        <div class="iris"></div>
        <div class="pupil"></div>
      </div>
      <div class="eye" aria-hidden="true">
        <div class="iris"></div>
        <div class="pupil"></div>
      </div>
    </div>

    <span class="footnote-anchor" id="fn-anchor-3">
      <sup class="footnote-marker" role="button" tabindex="0" aria-expanded="false" data-footnote="3" hidden>*</sup>
    </span>
    <div class="footnote-box" id="footnote-3" hidden>
      There are 2 epistemologies here. Each with its own vocabulary of concealment. Dancing, slipping in a sweaty duel. Web somatics might add latency to the poetic punch. Poetic language troubles the directness of interface.
    </div>
  </section>

  <button class="advance-arrow" data-advances-to="4" aria-label="Continue to next section" hidden>&#8594;</button>

  <!-- ========== PART 4 ========== -->
  <section id="part-4" data-part="4" aria-label="Part 4: Asymmetry" hidden>
    <div class="drag-transform" id="drag-transform" data-interactive>
      <div class="source-words" id="source-words">
        <span class="drag-word" data-src="0">Like</span>
        <span class="drag-word" data-src="1">the</span>
        <span class="drag-word" data-src="2">maiko,</span>
        <span class="drag-word" data-src="3">my</span>
        <span class="drag-word" data-src="4">economy</span>
        <span class="drag-word" data-src="5">of</span>
        <span class="drag-word" data-src="6">feelings</span>
      </div>
      <div class="oblique-line" aria-hidden="true"></div>
      <div class="target-words" id="target-words">
        <span class="target-word" data-tgt="0">is</span>
        <span class="target-word" data-tgt="1">a</span>
        <span class="target-word" data-tgt="2">management</span>
        <span class="target-word" data-tgt="3">of</span>
        <span class="target-word" data-tgt="4">asymmetry</span>
      </div>
    </div>

    <div class="float-container" id="float-container" hidden></div>

    <span class="footnote-anchor" id="fn-anchor-4">
      <sup class="footnote-marker" role="button" tabindex="0" aria-expanded="false" data-footnote="4" hidden>*</sup>
    </span>
    <div class="footnote-box" id="footnote-4" hidden>
      This might be a good time to talk about domination. How my body control kink leaches into my poetry. How I study the body of the words I choose.
    </div>
  </section>

  <button class="advance-arrow" data-advances-to="5" aria-label="Continue to next section" hidden>&#8594;</button>

  <!-- ========== PART 5 ========== -->
  <section id="part-5" data-part="5" aria-label="Part 5: HTML Element Poetry" hidden>
    <div class="p5-line" id="p5-power">
      <button class="p5-btn" id="p5-power-btn" data-interactive>And I am not writing about power.</button>
    </div>

    <div class="p5-line" id="p5-believe">
      <label class="p5-checkbox-label" for="p5-check" data-interactive>Believe me,</label>
      <input type="checkbox" class="p5-hidden-check" id="p5-check" tabindex="-1">
    </div>

    <div class="p5-line" id="p5-onething">
      <label for="p5-select" class="sr-only">I only write about</label>
      <span>I only write about </span>
      <select class="p5-select" id="p5-select" data-interactive>
        <option>one thing</option>
      </select>
    </div>

    <div class="p5-line" id="p5-glitch-line">
      <span class="p5-glitch" id="p5-glitch" data-interactive>Love</span>
    </div>

    <div class="p5-line" id="p5-negative">
      <details class="p5-details" data-interactive>
        <summary>&middot;</summary>
        <p>The negative space of mind.</p>
      </details>
    </div>

    <div class="p5-line" id="p5-neuron">
      <span class="p5-range-label" id="p5-range-label">The electric reach of every pumped neuron.</span>
      <input type="range" class="p5-range" id="p5-range" min="0" max="100" value="0" data-interactive>
    </div>

    <div class="p5-line" id="p5-mirror">
      <textarea class="p5-textarea" id="p5-textarea" readonly data-interactive>I write about the psychic mirror that turns accident into story and the side characters each of us are into hailed muscled heroes.</textarea>
      <div class="p5-mirror" id="p5-mirror-text" aria-hidden="true"></div>
    </div>

    <span class="footnote-anchor" id="fn-anchor-5">
      <sup class="footnote-marker" role="button" tabindex="0" aria-expanded="false" data-footnote="5" hidden>*</sup>
    </span>
    <div class="footnote-box" id="footnote-5" hidden>
      If poetry is the red skin of an obstacle the hero needs to shoot down with an arrow dipped in the hydra's blood, then web poetry is the wing. Maybe a concealing device when folded at a sharp angle. But mostly a troubling &mdash; or better yet, a fucking up &mdash; of a body's relationship to gravity. An insult to physics. Wide and graceful.
    </div>
  </section>

  <button class="advance-arrow" data-advances-to="wing" aria-label="Continue to ending" hidden>&#8594;</button>

  <!-- ========== WING ENDING ========== -->
  <section id="wing-section" aria-label="The Wing" hidden>
    <div class="wing-stage" id="wing-stage" tabindex="0" role="img" aria-label="A wing made of thin lines, click to watch it flap">
      <span class="wing-label">the wing</span>
      <div class="wing-perspective">
        <div class="wing-body" id="wing-body">
          <!-- feathers built by JS -->
        </div>
      </div>
      <span class="wing-hint" id="wing-hint">click</span>
    </div>
  </section>

</main>

<script>
/* ============================================================
   SEQUENCING ENGINE
   ============================================================ */
const state = { part: 1, step: 0, busy: false };

function prefersReducedMotion() {
  return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
}

const PARTS = {};
let partCompleteCallbacks = {};

function registerPart(num, steps) {
  PARTS[num] = { steps, el: document.getElementById('part-' + num) };
}

function advance() {
  if (state.busy) return;
  const part = PARTS[state.part];
  if (!part || state.step >= part.steps.length) return;
  state.busy = true;
  const stepFn = part.steps[state.step];
  state.step++;
  stepFn(() => {
    state.busy = false;
    checkPartComplete();
  });
}

function advanceWhenReady() {
  state.busy = false;
  state.step++;
  checkPartComplete();
}

function checkPartComplete() {
  const part = PARTS[state.part];
  if (!part) return;
  if (state.step >= part.steps.length) {
    // Show footnote marker
    const fn = document.querySelector(`[data-footnote="${state.part}"]`);
    if (fn) fn.hidden = false;
    // Show arrow
    const arrow = document.querySelector(`.advance-arrow[data-advances-to="${state.part + 1}"]`)
      || document.querySelector(`.advance-arrow[data-advances-to="wing"]`);
    if (arrow) arrow.hidden = false;
  }
}

function advancePart(target) {
  const nextPart = target || state.part + 1;
  // Cleanup current part
  if (state.part === 3) stopCamera();

  if (nextPart === 'wing') {
    state.part = 6;
    showWing();
    return;
  }

  state.part = nextPart;
  state.step = 0;
  state.busy = false;

  const section = document.getElementById('part-' + nextPart);
  if (section) {
    section.hidden = false;
    requestAnimationFrame(() => {
      section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      // Auto-trigger first step after scroll
      setTimeout(() => advance(), 600);
    });
  }
}

/* ============================================================
   FOOTNOTE SYSTEM
   ============================================================ */
function initFootnotes() {
  document.querySelectorAll('.footnote-marker').forEach(marker => {
    const num = marker.dataset.footnote;
    const box = document.getElementById('footnote-' + num);

    function toggle(e) {
      e.stopPropagation();
      const isOpen = !box.hidden;
      closeAllFootnotes();
      if (!isOpen) {
        box.hidden = false;
        marker.setAttribute('aria-expanded', 'true');
      }
    }

    marker.addEventListener('click', toggle);
    marker.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(e); }
    });
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('.footnote-box') && !e.target.closest('.footnote-marker')) {
      closeAllFootnotes();
    }
  });
}

function closeAllFootnotes() {
  document.querySelectorAll('.footnote-box').forEach(b => b.hidden = true);
  document.querySelectorAll('.footnote-marker').forEach(m => m.setAttribute('aria-expanded', 'false'));
}

/* ============================================================
   PART 1: AUTOBIOGRAPHY OF RED
   ============================================================ */
const LENS_STATES = [
  'The lens is a locked bedroom door.',
  'A border.',
  'And borders, as you get to know them,',
  'reveal themselves as more than enclosures.'
];
let lensIndex = 0;

registerPart(1, [
  // Step 0: Show opening line + red streak
  function(done) {
    const line = document.querySelector('#part-1 .line[data-step="0"]');
    line.classList.add('visible');
    setTimeout(done, prefersReducedMotion() ? 100 : 800);
  },
  // Step 1: Show lens button
  function(done) {
    document.getElementById('lens-btn').hidden = false;
    done();
    // Now the lens button drives its own sub-steps — don't auto-advance
  },
  // Step 2: Lens click 1 (already at state 0, advance to 1)
  function(done) {
    // This step is triggered by lens button click
    const txt = document.getElementById('lens-text');
    const circle = document.getElementById('lens-circle');
    circle.classList.add('visible');
    lensIndex = 1;
    txt.textContent = LENS_STATES[lensIndex];
    done();
  },
  // Step 3: Lens click 2
  function(done) {
    lensIndex = 2;
    document.getElementById('lens-text').textContent = LENS_STATES[lensIndex];
    done();
  },
  // Step 4: Lens click 3
  function(done) {
    lensIndex = 3;
    document.getElementById('lens-text').textContent = LENS_STATES[lensIndex];
    done();
  },
  // Step 5: Show "the figure from the ground" + invert
  function(done) {
    document.getElementById('lens-circle').classList.remove('visible');
    document.getElementById('lens-btn').hidden = true;
    const fig = document.getElementById('p1-figure-line');
    fig.classList.add('visible');
    setTimeout(() => {
      document.body.classList.add('inverted');
      setTimeout(done, prefersReducedMotion() ? 100 : 800);
    }, prefersReducedMotion() ? 100 : 500);
  }
]);

// Lens button drives steps 2-4
document.getElementById('lens-btn').addEventListener('click', () => {
  if (state.part !== 1) return;
  if (state.step >= 2 && state.step <= 4) {
    advance();
  } else if (state.step === 1) {
    // First lens click
    advance();
  }
});

/* ============================================================
   PART 2: SLOT MACHINE + WALL + DRAG + CURL
   ============================================================ */
const SLOT_STATES = [
  ['I','am','not','trying','to','hide'],
  ['I','am','',   'trying','to','hide'],
  ['I','am','',   'trying','',  ''    ],
  ['I','am','not','',      '',  ''    ],
  ['I','am','',   '',      '',  ''    ],
];
let slotState = 0;

function spinSlot(done) {
  slotState++;
  const next = SLOT_STATES[slotState];
  const prev = SLOT_STATES[slotState - 1];
  const reels = document.querySelectorAll('#slot-machine .reel');

  reels.forEach((reel, i) => {
    const strip = reel.querySelector('.reel-strip');
    if (prev[i] !== next[i]) {
      // Add new word to strip
      const el = document.createElement('span');
      el.className = 'reel-word';
      el.textContent = next[i] || '\u00A0';
      strip.appendChild(el);

      strip.style.setProperty('--target', `-${slotState * 1.8}em`);
      strip.classList.add('spinning');

      if (!prefersReducedMotion()) {
        strip.addEventListener('animationend', () => {
          strip.classList.remove('spinning');
          strip.style.transform = `translateY(-${slotState * 1.8}em)`;
        }, { once: true });
      } else {
        strip.classList.remove('spinning');
        strip.style.transform = `translateY(-${slotState * 1.8}em)`;
      }
    }

    // Collapse empty reels
    if (next[i] === '') {
      setTimeout(() => reel.classList.add('empty'), prefersReducedMotion() ? 0 : 300);
    } else {
      reel.classList.remove('empty');
    }
  });

  // "I am" — un-invert
  if (slotState === SLOT_STATES.length - 1) {
    setTimeout(() => {
      document.body.classList.remove('inverted');
    }, prefersReducedMotion() ? 0 : 400);
  }

  setTimeout(done, prefersReducedMotion() ? 100 : 700);
}

let wallIndex = 0;
function showWallPhrase(done) {
  const phrase = document.querySelector(`.wall-phrase[data-wall="${wallIndex}"]`);
  if (phrase) {
    phrase.classList.add('visible');
    wallIndex++;
  }
  setTimeout(done, prefersReducedMotion() ? 50 : 300);
}

let dragIndex = 0;
function initDragRects(done) {
  const rects = document.querySelectorAll('.drag-rect');
  dragIndex = 0;

  function activateNext() {
    if (dragIndex >= rects.length) {
      advanceWhenReady();
      return;
    }
    const rect = rects[dragIndex];
    makeDraggable(rect, {
      onDrop: () => {
        const t = rect.style.transform || '';
        const match = t.match(/translate\(([^,]+)px,\s*([^)]+)px\)/);
        if (match) {
          const dist = Math.hypot(parseFloat(match[1]), parseFloat(match[2]));
          if (dist > 100) {
            rect.classList.add('dismissed');
            dragIndex++;
            activateNext();
          }
        }
      }
    });
  }
  activateNext();
  // done is NOT called — advanceWhenReady() fires when all rects are dragged
}

function initCurlText(done) {
  const container = document.getElementById('curl-container');
  const text = container.textContent.trim();
  container.textContent = '';
  container.setAttribute('aria-label', text);

  [...text].forEach(char => {
    const span = document.createElement('span');
    span.textContent = char;
    span.className = 'curl-char';
    container.appendChild(span);
  });

  function handleMove(e) {
    const px = e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX);
    const py = e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY);
    if (px == null) return;

    container.querySelectorAll('.curl-char').forEach(span => {
      const r = span.getBoundingClientRect();
      const cx = r.left + r.width / 2;
      const cy = r.top + r.height / 2;
      const dist = Math.hypot(px - cx, py - cy);
      const maxDist = 150;
      if (dist < maxDist) {
        const force = (1 - dist / maxDist) * 20;
        const angle = Math.atan2(cy - py, cx - px);
        span.style.transform = `translate(${Math.cos(angle)*force}px, ${Math.sin(angle)*force}px)`;
      } else {
        span.style.transform = '';
      }
    });
  }

  document.addEventListener('pointermove', handleMove);
  // This step completes immediately — clicking advances past it
  done();
}

registerPart(2, [
  // Slot steps
  function(done) { spinSlot(done); },
  function(done) { spinSlot(done); },
  function(done) { spinSlot(done); },
  function(done) { spinSlot(done); },
  // Wall steps
  function(done) {
    document.getElementById('wall-container').hidden = false;
    showWallPhrase(done);
  },
  function(done) { showWallPhrase(done); },
  function(done) { showWallPhrase(done); },
  function(done) { showWallPhrase(done); },
  function(done) { showWallPhrase(done); },
  // Drag rectangles
  function(done) {
    document.getElementById('drag-stack').hidden = false;
    document.getElementById('drag-stack').scrollIntoView({ behavior: 'smooth', block: 'center' });
    initDragRects(done);
    // done is NOT called — advanceWhenReady handles it
  },
  // Curl text
  function(done) {
    const c = document.getElementById('curl-container');
    c.hidden = false;
    c.scrollIntoView({ behavior: 'smooth', block: 'center' });
    initCurlText(done);
  }
]);

/* ============================================================
   PART 3: CAMERA + SHY + EYES + EXPLOSION
   ============================================================ */
let cameraCleanup = null;
let eyeCleanup = null;

async function initCamera(done) {
  const container = document.getElementById('camera-container');
  const video = document.getElementById('camera-video');
  const canvas = document.getElementById('camera-canvas');
  container.hidden = false;
  container.scrollIntoView({ behavior: 'smooth', block: 'center' });

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 320 }, height: { ideal: 240 } }
    });
    video.srcObject = stream;
    await video.play();
    cameraCleanup = startRetroFilter(video, canvas);
  } catch (e) {
    cameraCleanup = startFallbackSurface(canvas);
  }
  setTimeout(done, 500);
}

function startRetroFilter(video, canvas) {
  const ctx = canvas.getContext('2d');
  const PX = 4;
  const w = Math.floor(canvas.width / PX);
  const h = Math.floor(canvas.height / PX);
  const off = document.createElement('canvas');
  off.width = w; off.height = h;
  const offCtx = off.getContext('2d');
  let animId;

  function render() {
    offCtx.drawImage(video, 0, 0, w, h);
    const img = offCtx.getImageData(0, 0, w, h);
    const d = img.data;
    for (let i = 0; i < d.length; i += 4) {
      const g = d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114;
      d[i] = d[i+1] = d[i+2] = g;
    }
    offCtx.putImageData(img, 0, 0);
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(off, 0, 0, canvas.width, canvas.height);
    animId = requestAnimationFrame(render);
  }
  render();
  return () => { cancelAnimationFrame(animId); };
}

function startFallbackSurface(canvas) {
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  let t = 0, animId;

  function render() {
    t += 0.02;
    const img = ctx.createImageData(w, h);
    const d = img.data;
    for (let y = 0; y < h; y++) {
      for (let x = 0; x < w; x++) {
        const i = (y * w + x) * 4;
        const v = 200 + 55 * Math.sin(x*0.05+t) * Math.cos(y*0.07+t*0.7) * Math.sin((x+y)*0.03+t*1.3);
        const gray = Math.max(180, Math.min(255, v));
        d[i] = d[i+1] = d[i+2] = gray;
        d[i+3] = 255;
      }
    }
    ctx.putImageData(img, 0, 0);
    animId = requestAnimationFrame(render);
  }

  if (prefersReducedMotion()) {
    // Single static frame
    t = 1;
    const img = ctx.createImageData(w, h);
    const d = img.data;
    for (let y = 0; y < h; y++) {
      for (let x = 0; x < w; x++) {
        const i = (y * w + x) * 4;
        const v = 200 + 55 * Math.sin(x*0.05+1) * Math.cos(y*0.07+0.7) * Math.sin((x+y)*0.03+1.3);
        d[i] = d[i+1] = d[i+2] = Math.max(180, Math.min(255, v));
        d[i+3] = 255;
      }
    }
    ctx.putImageData(img, 0, 0);
    return () => {};
  }

  render();
  return () => { cancelAnimationFrame(animId); };
}

function stopCamera() {
  const video = document.getElementById('camera-video');
  if (video && video.srcObject) {
    video.srcObject.getTracks().forEach(t => t.stop());
    video.srcObject = null;
  }
  if (cameraCleanup) { cameraCleanup(); cameraCleanup = null; }
  if (eyeCleanup) { eyeCleanup(); eyeCleanup = null; }
}

function animateShy(done) {
  const el = document.getElementById('shy-word');
  el.classList.add('bold');
  setTimeout(() => {
    el.classList.add('jump');
    setTimeout(() => {
      el.classList.add('grow');
      setTimeout(done, prefersReducedMotion() ? 100 : 500);
    }, prefersReducedMotion() ? 100 : 500);
  }, prefersReducedMotion() ? 100 : 300);
}

function initEyes(done) {
  const container = document.getElementById('eyes-container');
  container.hidden = false;
  container.scrollIntoView({ behavior: 'smooth', block: 'center' });

  const eyes = container.querySelectorAll('.eye');
  const MAX_OFFSET = 15;
  let pauseTimer = null;
  const CENTER_RADIUS = 40;
  const PAUSE_MS = 3000;

  function getCenterZone() {
    const r0 = eyes[0].getBoundingClientRect();
    const r1 = eyes[1].getBoundingClientRect();
    return {
      x: (r0.left + r0.width/2 + r1.left + r1.width/2) / 2,
      y: (r0.top + r0.height/2 + r1.top + r1.height/2) / 2
    };
  }

  function handleMove(e) {
    const px = e.clientX, py = e.clientY;
    eyes.forEach(eye => {
      const r = eye.getBoundingClientRect();
      const cx = r.left + r.width/2, cy = r.top + r.height/2;
      const angle = Math.atan2(py - cy, px - cx);
      const dist = Math.min(Math.hypot(px - cx, py - cy) / 10, MAX_OFFSET);
      const dx = Math.cos(angle) * dist;
      const dy = Math.sin(angle) * dist;
      eye.querySelector('.iris').style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
      eye.querySelector('.pupil').style.transform = `translate(calc(-50% + ${dx*1.2}px), calc(-50% + ${dy*1.2}px))`;
    });

    // Center zone check
    const center = getCenterZone();
    const d = Math.hypot(px - center.x, py - center.y);
    if (d <= CENTER_RADIUS) {
      if (!pauseTimer) {
        pauseTimer = setTimeout(triggerExplosion, PAUSE_MS);
      }
    } else {
      clearTimeout(pauseTimer);
      pauseTimer = null;
    }
  }

  document.addEventListener('pointermove', handleMove);
  eyeCleanup = () => {
    document.removeEventListener('pointermove', handleMove);
    clearTimeout(pauseTimer);
  };
  // done is NOT called — explosion advances
}

function triggerExplosion() {
  const container = document.getElementById('part-3');
  const els = container.querySelectorAll('.line.visible, .eye, .camera-container');
  const cx = window.innerWidth / 2, cy = window.innerHeight / 2;

  if (prefersReducedMotion()) {
    els.forEach(el => {
      el.style.transition = 'opacity 0.3s ease';
      el.style.opacity = '0';
    });
  } else {
    els.forEach(el => {
      const r = el.getBoundingClientRect();
      const ex = r.left + r.width/2, ey = r.top + r.height/2;
      const angle = Math.atan2(ey - cy, ex - cx);
      const dist = 600 + Math.random() * 400;
      const tx = Math.cos(angle) * dist;
      const ty = Math.sin(angle) * dist;
      const rot = (Math.random() - 0.5) * 720;
      el.style.transition = 'transform 1s cubic-bezier(0.25,0,0.5,1), opacity 1s ease';
      el.style.transform = `translate(${tx}px, ${ty}px) rotate(${rot}deg)`;
      el.style.opacity = '0';
    });
  }

  setTimeout(() => {
    advanceWhenReady();
  }, prefersReducedMotion() ? 400 : 1200);
}

registerPart(3, [
  // Step 0: "Take my face" + camera
  function(done) {
    document.querySelector('#part-3 .line[data-step="camera"]').classList.add('visible');
    setTimeout(() => initCamera(done), prefersReducedMotion() ? 100 : 600);
  },
  // Step 1: "I am not shy" + shy animation
  function(done) {
    document.querySelector('#part-3 .line[data-step="shy"]').classList.add('visible');
    setTimeout(() => animateShy(done), prefersReducedMotion() ? 100 : 400);
  },
  // Step 2: maiko text + eyes
  function(done) {
    document.querySelector('#part-3 .line[data-step="maiko"]').classList.add('visible');
    setTimeout(() => initEyes(done), prefersReducedMotion() ? 100 : 600);
    // done is NOT called — explosion handles it via advanceWhenReady
  },
]);

/* ============================================================
   PART 4: DRAG TRANSFORM + FLOATING TEXT
   ============================================================ */
let p4CrossCount = 0;

function initDragTransform(done) {
  const words = document.querySelectorAll('.drag-word');
  const targets = document.querySelectorAll('.target-word');
  const line = document.querySelector('.oblique-line');
  p4CrossCount = 0;

  words.forEach((word, i) => {
    makeDraggable(word, {
      onDrop: () => {
        const wordRect = word.getBoundingClientRect();
        const lineRect = line.getBoundingClientRect();
        // Check if word crossed the line
        if (wordRect.left > lineRect.left) {
          word.classList.add('crossed');
          if (p4CrossCount < targets.length) {
            targets[p4CrossCount].classList.add('revealed');
          }
          p4CrossCount++;
          if (p4CrossCount >= words.length) {
            advanceWhenReady();
          }
        }
      }
    });
  });
  // done NOT called — advanceWhenReady fires on completion
}

function initFloatingText(done) {
  const container = document.getElementById('float-container');
  container.hidden = false;
  container.scrollIntoView({ behavior: 'smooth', block: 'center' });

  const passage = "Cruel not like a destiny, rather like Heracles towards Geryon in Anne Carson's book. Often tragedy isn't violent, it just doesn't care enough. It is devastating in how its ordinariness meets our infatuation.";
  const words = passage.split(' ');
  let idx = 0;
  const interval = 500;

  function showNext() {
    if (idx >= words.length) {
      setTimeout(() => advanceWhenReady(), 2000);
      return;
    }
    const span = document.createElement('span');
    span.className = 'float-word';
    span.textContent = words[idx] + ' ';
    container.appendChild(span);

    if (!prefersReducedMotion()) {
      const angle = Math.random() * Math.PI * 2;
      const dist = window.innerHeight * 0.8;
      const dx = Math.cos(angle) * dist;
      const dy = Math.sin(angle) * dist;
      const dur = 3000 + Math.random() * 2000;

      requestAnimationFrame(() => {
        span.style.transition = `transform ${dur}ms linear, opacity ${dur}ms ease-in`;
        span.style.transform = `translate(${dx}px, ${dy}px)`;
        span.style.opacity = '0';
      });
    } else {
      setTimeout(() => { span.style.opacity = '0'; span.style.transition = 'opacity 0.5s'; }, 1500);
    }

    idx++;
    setTimeout(showNext, interval);
  }
  showNext();
  // done NOT called
}

registerPart(4, [
  function(done) { initDragTransform(done); },
  function(done) { initFloatingText(done); }
]);

/* ============================================================
   PART 5: HTML ELEMENT POETRY
   ============================================================ */
const GLITCH_WORDS = ['Love', 'Money', 'Fasting', 'The synapse'];
let glitchIndex = 0;

function glitchTransition(el, target, callback) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%&*';
  if (prefersReducedMotion()) {
    el.textContent = target;
    if (callback) callback();
    return;
  }
  const duration = 600, frameMs = 40;
  const totalFrames = duration / frameMs;
  let frame = 0;
  const maxLen = Math.max(el.textContent.length, target.length);

  const iv = setInterval(() => {
    frame++;
    let result = '';
    for (let i = 0; i < maxLen; i++) {
      const settle = (i / maxLen) * totalFrames;
      if (frame > settle + totalFrames * 0.6) {
        result += target[i] || '';
      } else {
        result += chars[Math.floor(Math.random() * chars.length)];
      }
    }
    el.textContent = result;
    if (frame >= totalFrames) {
      clearInterval(iv);
      el.textContent = target;
      if (callback) callback();
    }
  }, frameMs);
}

registerPart(5, [
  // "And I am not writing about power"
  function(done) {
    const line = document.getElementById('p5-power');
    line.classList.add('visible');
    const btn = document.getElementById('p5-power-btn');
    btn.addEventListener('click', () => {
      btn.classList.add('flash');
      setTimeout(() => btn.classList.remove('flash'), 200);
    });
    setTimeout(done, 400);
  },
  // "Believe me"
  function(done) {
    document.getElementById('p5-believe').classList.add('visible');
    setTimeout(done, 400);
  },
  // "I only write about one thing"
  function(done) {
    document.getElementById('p5-onething').classList.add('visible');
    setTimeout(done, 400);
  },
  // "Love" (first glitch word)
  function(done) {
    const line = document.getElementById('p5-glitch-line');
    line.classList.add('visible');
    glitchIndex = 0;
    done();
  },
  // glitch → Money
  function(done) {
    glitchIndex = 1;
    glitchTransition(document.getElementById('p5-glitch'), GLITCH_WORDS[1], done);
  },
  // glitch → Fasting
  function(done) {
    glitchIndex = 2;
    glitchTransition(document.getElementById('p5-glitch'), GLITCH_WORDS[2], done);
  },
  // glitch → The synapse
  function(done) {
    glitchIndex = 3;
    glitchTransition(document.getElementById('p5-glitch'), GLITCH_WORDS[3], done);
  },
  // "The negative space of mind"
  function(done) {
    document.getElementById('p5-negative').classList.add('visible');
    setTimeout(done, 400);
  },
  // "The electric reach"
  function(done) {
    const line = document.getElementById('p5-neuron');
    line.classList.add('visible');
    const slider = document.getElementById('p5-range');
    const label = document.getElementById('p5-range-label');
    slider.addEventListener('input', () => {
      const v = slider.value;
      label.style.letterSpacing = (v / 10) + 'px';
      if (v >= 90) {
        // Pulse effect
        label.style.opacity = '0.6';
        setTimeout(() => { label.style.opacity = '1'; }, 100);
      }
    });
    setTimeout(done, 400);
  },
  // "I write about the psychic mirror..."
  function(done) {
    const line = document.getElementById('p5-mirror');
    line.classList.add('visible');
    const ta = document.getElementById('p5-textarea');
    const mirror = document.getElementById('p5-mirror-text');
    mirror.textContent = ta.value;
    ta.removeAttribute('readonly');
    ta.addEventListener('input', () => {
      mirror.textContent = ta.value;
    });
    setTimeout(done, 400);
  }
]);

/* ============================================================
   WING
   ============================================================ */
function buildWing() {
  const body = document.getElementById('wing-body');
  body.innerHTML = '';

  const featherTexts = ['the wing', 'a concealing device', 'web poetry', 'an insult to physics', 'wide and graceful'];
  let textIdx = 0;

  // Primary feathers
  for (let i = 0; i < 9; i++) {
    const angle = -15 - i * 16.5;
    const len = 180 + i * 10;
    const f = document.createElement('div');
    f.className = 'feather';
    f.style.width = len + 'px';
    f.style.height = '2px';
    f.style.setProperty('--angle', angle + 'deg');
    f.style.setProperty('--y-tilt', (i * 2 - 8) + 'deg');
    f.style.setProperty('--delay', (i * 0.015) + 's');
    f.style.transform = `rotateZ(${angle}deg) rotateY(${i*2-8}deg) translateZ(${i}px)`;
    if (i % 2 === 0 && textIdx < featherTexts.length) {
      const txt = document.createElement('span');
      txt.className = 'feather-text';
      txt.textContent = featherTexts[textIdx++];
      f.appendChild(txt);
    }
    body.appendChild(f);
  }

  // Secondary feathers
  for (let i = 0; i < 12; i++) {
    const angle = -10 - i * 13;
    const len = 100 + i * 6;
    const f = document.createElement('div');
    f.className = 'feather';
    f.style.width = len + 'px';
    f.style.height = '1px';
    f.style.opacity = '0.7';
    f.style.setProperty('--angle', angle + 'deg');
    f.style.setProperty('--y-tilt', (i * 1.5 - 6) + 'deg');
    f.style.setProperty('--delay', (i * 0.012 + 0.05) + 's');
    f.style.transform = `rotateZ(${angle}deg) rotateY(${i*1.5-6}deg) translateZ(${i*0.5}px)`;
    body.appendChild(f);
  }

  // Tertiary feathers
  for (let i = 0; i < 14; i++) {
    const angle = -8 - i * 10;
    const len = 50 + i * 4;
    const f = document.createElement('div');
    f.className = 'feather';
    f.style.width = len + 'px';
    f.style.height = '1px';
    f.style.opacity = '0.35';
    f.style.setProperty('--angle', angle + 'deg');
    f.style.setProperty('--y-tilt', (i - 5) + 'deg');
    f.style.setProperty('--delay', (i * 0.01 + 0.1) + 's');
    f.style.transform = `rotateZ(${angle}deg) rotateY(${i-5}deg) translateZ(${i*0.3}px)`;
    body.appendChild(f);
  }
}

function flapWing() {
  const body = document.getElementById('wing-body');
  body.classList.remove('flapping');
  void body.offsetHeight; // force reflow
  body.classList.add('flapping');
  body.addEventListener('animationend', () => {
    body.classList.remove('flapping');
  }, { once: true });
}

function showWing() {
  const section = document.getElementById('wing-section');
  section.hidden = false;
  buildWing();

  requestAnimationFrame(() => {
    section.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => {
      document.getElementById('wing-hint').classList.add('visible');
    }, 1000);
  });

  document.getElementById('wing-stage').addEventListener('click', flapWing);
  document.getElementById('wing-stage').addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); flapWing(); }
  });

  // Show Part 5 footnote if not already shown
  const fn5 = document.querySelector('[data-footnote="5"]');
  if (fn5) fn5.hidden = false;
}

/* ============================================================
   DRAG UTILITY
   ============================================================ */
function makeDraggable(el, opts = {}) {
  let dragging = false, startX, startY;
  el.style.touchAction = 'none';
  el.setAttribute('tabindex', '0');

  el.addEventListener('pointerdown', e => {
    dragging = true;
    el.setPointerCapture(e.pointerId);
    startX = e.clientX;
    startY = e.clientY;
    el.classList.add('dragging');
  });

  el.addEventListener('pointermove', e => {
    if (!dragging) return;
    e.preventDefault();
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    el.style.transform = `translate(${dx}px, ${dy}px)`;
    if (opts.onMove) opts.onMove(dx, dy, e);
  });

  el.addEventListener('pointerup', e => {
    if (!dragging) return;
    dragging = false;
    el.classList.remove('dragging');
    if (opts.onDrop) opts.onDrop(e);
  });

  el.addEventListener('pointercancel', () => {
    dragging = false;
    el.classList.remove('dragging');
  });

  // Keyboard fallback
  el.addEventListener('keydown', e => {
    const S = 20;
    const m = (el.style.transform || '').match(/translate\(([^,]+)px,\s*([^)]+)px\)/);
    let tx = m ? parseFloat(m[1]) : 0;
    let ty = m ? parseFloat(m[2]) : 0;
    switch (e.key) {
      case 'ArrowLeft':  tx -= S; break;
      case 'ArrowRight': tx += S; break;
      case 'ArrowUp':    ty -= S; break;
      case 'ArrowDown':  ty += S; break;
      default: return;
    }
    e.preventDefault();
    el.style.transform = `translate(${tx}px, ${ty}px)`;
    if (opts.onMove) opts.onMove(tx, ty, e);
    if (opts.onDrop) opts.onDrop(e);
  });
}

/* ============================================================
   SECTION CLICK HANDLER
   ============================================================ */
function handleSectionClick(e) {
  if (e.target.closest('[data-interactive]')) return;
  if (e.target.closest('.footnote-marker') || e.target.closest('.footnote-box')) return;
  if (e.target.closest('.advance-arrow')) return;
  advance();
}

/* ============================================================
   INIT
   ============================================================ */
document.addEventListener('DOMContentLoaded', () => {
  if ('scrollRestoration' in history) {
    history.scrollRestoration = 'manual';
  }
  window.scrollTo(0, 0);

  initFootnotes();

  // Arrow buttons
  document.querySelectorAll('.advance-arrow').forEach(arrow => {
    arrow.addEventListener('click', () => {
      const target = arrow.dataset.advancesTo;
      arrow.hidden = true;
      advancePart(target === 'wing' ? 'wing' : parseInt(target));
    });
  });

  // Section clicks
  document.querySelectorAll('section[data-part]').forEach(section => {
    section.addEventListener('click', handleSectionClick);
  });

  // Debounce
  const origAdvance = advance;
  let locked = false;
  window.advance = function() {
    if (locked) return;
    locked = true;
    origAdvance();
    setTimeout(() => { locked = false; }, 300);
  };
  // But keep the original accessible
  window._rawAdvance = origAdvance;

  // Start Part 1
  advance();
});
</script>
</body>
</html>
